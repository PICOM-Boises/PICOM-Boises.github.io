<!doctype html>
<html lang="fr"> 
<head> 
	<meta charset="utf-8">
	<title>Projet PICOM boisés UQTR</title> 
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
	<script src="indice_geojson.json"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
</head>
<body>
<h1>Projet PICOM boisés UQTR</h1>
<p>Un petit texte avant la carte</p>
<div id="map" style="height:600px" ></div>
<p>Et un autre petit bout de texte après</p>
	<div class="legende" id="carbone">
		Texte de l'indice Carbone
	</div>
	<div class="legende" id="biodiversite">
		Texte de l'indice biodiversité
	</div>
	<div class="legende" id="temperature">
		Texte de l'indice température
	</div>	
	<div class="legende" id="Combine">
		Importance à donner à chaque indice pour le combiné : <br />
	</div>
	<script>

		// "properties":{"OBJECTID":1,"Catégorie":"Forestier","Type":"Pinède grise","zone_echan":23,"Field":0,"permeabilité":5,"carbone":4,"biodiversite":2,"temperature":3,"Indice":3.5,"Shape_Length":4477.8209635709882,"Shape_Area":81258.039305174549}

		const etiquette_indices_combines = "Indices combinés"
		
		const fillOpacity = 0.75;
		
		function getColorGradient(d) {
		    return d > 4 ? '#800026' :
		           d > 3  ? '#E31A1C' :
		           d > 2   ? '#FD8D3C' :
		           d > 1   ? '#FED976' :
		                      '#FFEDA0';
		}
		
		const liste_couleurs_ecosystemes = {
			"Pinède grise" : "#4a711a",
			"Jeune Pinède blanche" : "#cf2b30",
			"Mixte": "#4b3aba",
			"Mixte suranné" : "#0081a6",
			"Pinède blanche à pin gris" : "#95e2c3",
			"Pinède Sylvestre" : "#9f523d",
			"Vieille pinède blanche" : "#ee962a",
			"Pessière norvégienne" : "#27c8c2",
			"Milieu humide" : "#00c47c",
			"Pelouse arborée" : "#fff",
			"Surface minéralisée" : "#ccc",
			"Pelouse" : "#fffc47"			
		}
		
		function getColorES(d) {
			return liste_couleurs_ecosystemes[d];
		}
		
		function cleanToId(str) {
		  return str
		    .toLowerCase()                                      // Convert to lowercase.
		    .normalize('NFD')                                   // Decompose accented letters.
		    .replace(/[\u0300-\u036f]/g, '')                    // Remove diacritical marks.
		    .trim()                                             // Remove leading/trailing whitespace.
		    .replace(/\s+/g, '_')                               // Replace spaces with hyphens.
		    .replace(/[^a-z0-9\-_:.]/g, '');                     // Remove any non-allowed characters.
		}
				
		let map = L.map('map').setView([46.345, -72.580], 15);
		
		const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
				maxZoom: 19,
				attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
			}).addTo(map);		

		let indices = {

			Type:"Écosystèmes",
			"Indice perméabilité":"Service : Perméabilité",
			"Indice température":"Service : Température",
			"Indice carbone":"Service : Carbone",
			"Indice biodiversité":"Service : Biodiversité",
			"Indice service culturel":"Service : Culturel",
			"Indice champignons":"Service : Champignons",

			"Indice écosystémique global":"Indice global services",

			"Indice dépots de neige":"Risque : Dépôts de neige",
			"Indice intempéries":"Risque : Intempéries",
			"Indice maladies":"Risque : Maladies",
			"Indice espèces envahissantes":"Risque : Espèces envahissantes",

			"Indice mortalité":"Risque : Mortalité",

			"Indice de risque global":"Indice global risques",

		}
		
		let a_enlever_du_calcul = ["Type", "Indice écosystémique global", "Indice de risque global","Combine"]
		
		for (let [cle,etiquette] of Object.entries(indices)) {
			if (!(a_enlever_du_calcul.map(cleanToId).includes(cleanToId(cle)))) {
				$('.legende#Combine').append(`${etiquette} : <input type="range" id="${cleanToId(cle)}"/><br />`);
			}
		}

		let mise_a_jour_indice_combine = function() {
			for (feature of layers_picom.features) {
						
				let somme_valeurs = 0;
				let somme_poids = 0;
				
				for (indice of Object.keys(indices)) {
					if (!(a_enlever_du_calcul.includes(indice))) {
						//console.log("indice:" + indice)
						//console.log("property:" + feature.properties[indice])
						//console.log("value:" + $('input[type=range]#'+cleanToId(indice))[0].value)
						somme_valeurs += feature.properties[indice] * Number($('input[type=range]#'+cleanToId(indice))[0].value);
						
						somme_poids += Number($('input[type=range]#'+cleanToId(indice))[0].value);
					}
				}
				
				feature.properties.Combine = somme_valeurs / somme_poids
				
			}
			
		}
	
		mise_a_jour_indice_combine();
		
		let couches = []
		cles = Object.keys(indices);
		for (i=0;i<cles.length; i++ ) {
			
			cle = cles[i];
						
			couche = L.geoJSON(layers_picom, {
    		style: function (feature) {
				
				if (cle == "Type") {				
					color_function = getColorES(feature.properties[cle]);
				} else {
					color_function = getColorGradient(feature.properties[cle]);
				}
				
				return {
					fillColor: color_function,
					color: color_function,
					fillOpacity: fillOpacity
				};
			}})
			
			couche.id = cle;
						
			couches[indices[cle]] = couche
									
		}
		
		let layerControl = L.control.layers(couches).addTo(map);
			
		map.on("layeradd",function(e) {
			
			if (e.layer.id) { // L'événement se déclenche pour d'autres raisons?!				
				$(".legende").hide();
				$("#"+e.layer.id).show();
				
				if (e.layer.id != "Type") {
					$(".echelle_couleurs").show();
					$(".echelle_es").hide();
				} else {
					$(".echelle_couleurs").hide();
					$(".echelle_es").show();
				}
			}
		})
		
		// Par défaut, activer la carte des écosystèmes
		couches[indices["Type"]].addTo(map);
		
				
		$('input[type=range]').on("change",function(){							
			
			mise_a_jour_indice_combine();			
			
			let couche = L.geoJSON(layers_picom, {
    		style: function (feature) {
				return {
					fillColor: getColorGradient(feature.properties['Combine']),
					color: getColorGradient(feature.properties['Combine']),
					fillOpacity: fillOpacity
				};
			}})	
			couche.id = "Combine";
			
			layerControl.removeLayer(couches[etiquette_indices_combines]);
			map.removeLayer(couches[etiquette_indices_combines]);
			
			couches[etiquette_indices_combines] = couche;
					
			map.addLayer(couches[etiquette_indices_combines],etiquette_indices_combines);
			layerControl.addBaseLayer(couches[etiquette_indices_combines],etiquette_indices_combines);
			
			
		})
		
		var legend = L.control({position: 'bottomright'});

		legend.onAdd = function (map) {

		    var div = L.DomUtil.create('div', 'info echelle_couleurs'),
		        grades = [0,1,2,3,4],
		        labels = [];

				for (var i = 0; i < grades.length; i++) {
		        div.innerHTML +=
		            '<i style="background:' + getColorGradient(grades[i] + 1) + '"></i> ' +
		            grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
		    }

		    return div;
		};

		legend.addTo(map);

		var legend2 = L.control({position: 'bottomright'});

		legend2.onAdd = function (map) {

		    var div = L.DomUtil.create('div', 'info echelle_es'),
		        grades = Object.keys(liste_couleurs_ecosystemes),
		        labels = [];

				for (var i = 0; i < grades.length; i++) {
		        div.innerHTML +=
		            '<i style="background:' + getColorES(grades[i]) + '"></i> ' + grades[i]  + '<br>';
		    }

		    return div;
		};

		legend2.addTo(map);
		
		$(".legende").hide();
		$(".echelle_couleurs").hide();
		$(".echelle_es").show();
				
	</script>
	<style>
		.echelle_couleurs, .echelle_es {
		    line-height: 18px;
		    color: #555;
			background-color:white;
			padding: 10px;
		}
		.echelle_couleurs i, .echelle_es i {
		    width: 18px;
		    height: 18px;
		    float: left;
		    margin-right: 8px;
		    opacity: 0.75;
		}
	</style>
</body>
</html>