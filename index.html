<!doctype html>
<html lang="fr"> 
<head> 
	<meta charset="utf-8">
	<title>Projet PICOM boisés UQTR</title> 
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
	<script src="indice_eco.geojson"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
</head>
<body>
<h1>Projet PICOM boisés UQTR</h1>
<p>Un petit texte avant la carte</p>
<div id="map" style="height:600px" ></div>
<p>Et un autre petit bout de texte après</p>
	<div class="legende" id="Indice1">
		La légende du 1er indice
	</div>
	<div class="legende" id="Indice2">
		La légende du 2e indice
	</div>
	<div class="legende" id="Combine">
		Importance à donner à chaque indice pour le combiné : <br />
	</div>
	<script>

		// "properties":{"OBJECTID":1,"Catégorie":"Forestier","Type":"Pinède grise","zone_echan":23,"Field":0,"permeabilité":5,"carbone":4,"biodiversite":2,"temperature":3,"Indice":3.5,"Shape_Length":4477.8209635709882,"Shape_Area":81258.039305174549}

		const etiquette_indices_combines = "Indices combinés"
		
		function getColor(d) {
		    return d > 4 ? '#800026' :
		           d > 3  ? '#E31A1C' :
		           d > 2   ? '#FD8D3C' :
		           d > 1   ? '#FED976' :
		                      '#FFEDA0';
		}
				
		let map = L.map('map').setView([46.345, -72.585], 16);
		
		const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
				maxZoom: 19,
				attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
			}).addTo(map);		

		let indices = {
			/*Indice1:"Indice 1",
			Indice2:"Indice 2",*/
//			permeabilité:"Perméabilité",
			carbone:"Carbone",
			biodiversite:"Biodiversité",
			temperature:"Température",
			Combine:etiquette_indices_combines
		}
		
		for (let [cle,etiquette] of Object.entries(indices)) {
			if (cle != "Combine") {
				$('.legende#Combine').append(`${etiquette} : <input type="range" id="${cle}"/><br />`);
			}
		}

		let mise_a_jour_indice_combine = function() {
			for (feature of layers_picom.features) {
						
				let somme_valeurs = 0;
				let somme_poids = 0;
				
				for (indice of Object.keys(indices)) {
					if (indice != 'Combine') {											
						somme_valeurs += feature.properties[indice] * Number($('input[type=range]#'+indice)[0].value);
						
						somme_poids += Number($('input[type=range]#'+indice)[0].value);
					}
				}
				
				feature.properties.Combine = somme_valeurs / somme_poids
				
			}
			
		}
	
		mise_a_jour_indice_combine();
		
		let couches = []
		cles = Object.keys(indices);
		for (i=0;i<cles.length; i++ ) {
			
			cle = cles[i];
			
			couche = L.geoJSON(layers_picom, {
    		style: function (feature) {
				return {
					fillColor: getColor(feature.properties[cle]),
					color: getColor(feature.properties[cle]),
					fillOpacity: 0.5
				};
			}})
			
			couche.id = cle;
						
			couches[indices[cle]] = couche
									
		}
		
		let layerControl = L.control.layers(couches).addTo(map);
	
		$(".legende").hide();
		
		map.on("layeradd",function(e) {
			
			if (e.layer.id) { // L'événement se déclenche pour d'autres raisons?!				
				$(".legende").hide();
				$("#"+e.layer.id).show();
			}
		})
		
		// Activer le 1er indice
		couches[indices["carbone"]].addTo(map);
		
				
		$('input[type=range]').on("change",function(){							
			
			mise_a_jour_indice_combine();			
			
			let couche = L.geoJSON(layers_picom, {
    		style: function (feature) {
				return {
					fillColor: getColor(feature.properties['Combine']),
					color: getColor(feature.properties['Combine']),
					fillOpacity: 0.5
				};
			}})	
			couche.id = "Combine";
			
			layerControl.removeLayer(couches[etiquette_indices_combines]);
			map.removeLayer(couches[etiquette_indices_combines]);
			
			couches[etiquette_indices_combines] = couche;
					
			map.addLayer(couches[etiquette_indices_combines],etiquette_indices_combines);
			layerControl.addBaseLayer(couches[etiquette_indices_combines],etiquette_indices_combines);
			
			
		})
				
	</script>
</body>
</html>